name: Build and Push Docker Images to ECR

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  AWS_REGION: eu-central-1
  ECR_REGISTRY: 026596707189.dkr.ecr.eu-central-1.amazonaws.com
  ECR_REPOSITORY_BACKEND: moni-be
  ECR_REPOSITORY_FRONTEND: moni-fe

jobs:
  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: FE/moni-fe/package-lock.json

    - name: Build Backend JAR
      run: |
        echo "ðŸ”¨ Building Spring Boot JAR..."
        mvn -B clean package -DskipTests --file pom.xml
        ls -la target/
        
    - name: Build Frontend
      run: |
        echo "ðŸ”¨ Building Vue.js Frontend..."
        cd FE/moni-fe
        npm ci
        npm run build
        ls -la dist/

    - name: Build and tag Backend Docker image
      run: |
        echo "ðŸ³ Building Backend Docker image with pre-built JAR..."
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY_BACKEND:latest \
                     -t $ECR_REGISTRY/$ECR_REPOSITORY_BACKEND:${{ github.sha }} .
        echo "Backend image built successfully"

    - name: Build and tag Frontend Docker image
      run: |
        echo "ðŸ³ Building Frontend Docker image..."
        cd FE/moni-fe
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY_FRONTEND:latest \
                     -t $ECR_REGISTRY/$ECR_REPOSITORY_FRONTEND:${{ github.sha }} .
        echo "Frontend image built successfully"

    - name: Push Backend image to ECR
      run: |
        echo "ðŸš€ Pushing Backend image to ECR..."
        docker push $ECR_REGISTRY/$ECR_REPOSITORY_BACKEND:latest
        docker push $ECR_REGISTRY/$ECR_REPOSITORY_BACKEND:${{ github.sha }}
        echo "Backend image pushed successfully"

    - name: Push Frontend image to ECR
      run: |
        echo "ðŸš€ Pushing Frontend image to ECR..."
        docker push $ECR_REGISTRY/$ECR_REPOSITORY_FRONTEND:latest
        docker push $ECR_REGISTRY/$ECR_REPOSITORY_FRONTEND:${{ github.sha }}
        echo "Frontend image pushed successfully"

    - name: Output image URIs
      run: |
        echo "âœ… Build and Push Complete!"
        echo "Backend Image: $ECR_REGISTRY/$ECR_REPOSITORY_BACKEND:latest"
        echo "Backend SHA: $ECR_REGISTRY/$ECR_REPOSITORY_BACKEND:${{ github.sha }}"
        echo "Frontend Image: $ECR_REGISTRY/$ECR_REPOSITORY_FRONTEND:latest" 
        echo "Frontend SHA: $ECR_REGISTRY/$ECR_REPOSITORY_FRONTEND:${{ github.sha }}"
        echo ""
        echo "ðŸš€ Images are ready for deployment!"

    - name: Update dependency graph
      uses: advanced-security/maven-dependency-submission-action@571e99aab1055c2e71a1e2309b9691de18d6b7d6

    - name: Create deployment summary
      run: |
        echo "## ðŸ³ Docker Images Built and Pushed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Backend (Spring Boot)" >> $GITHUB_STEP_SUMMARY
        echo "- **Latest:** \`$ECR_REGISTRY/$ECR_REPOSITORY_BACKEND:latest\`" >> $GITHUB_STEP_SUMMARY
        echo "- **SHA:** \`$ECR_REGISTRY/$ECR_REPOSITORY_BACKEND:${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Frontend (Vue.js)" >> $GITHUB_STEP_SUMMARY
        echo "- **Latest:** \`$ECR_REGISTRY/$ECR_REPOSITORY_FRONTEND:latest\`" >> $GITHUB_STEP_SUMMARY
        echo "- **SHA:** \`$ECR_REGISTRY/$ECR_REPOSITORY_FRONTEND:${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸš€ Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "Use your deployment scripts to update the running application:" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
        echo "./manage-app.sh <EC2_IP> update" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY