name: Deploy to EC2 after ECR Push

on:
  workflow_run:
    workflows: ["Build and Push Docker Images to ECR"]
    types:
      - completed
    branches: [main]

env:
  AWS_REGION: eu-central-1

jobs:
  deploy-to-ec2:
    name: Deploy Latest Images to EC2
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Get EC2 Instance IP
      id: get-ip
      run: |
        # Get the EC2 instance IP from terraform output (if available)
        # This assumes your EC2 instance has a specific tag
        INSTANCE_IP=$(aws ec2 describe-instances \
          --filters "Name=tag:Name,Values=moni-dev-k3s" "Name=instance-state-name,Values=running" \
          --query "Reservations[0].Instances[0].PublicIpAddress" \
          --output text 2>/dev/null || echo "")
        
        if [ "$INSTANCE_IP" = "None" ] || [ -z "$INSTANCE_IP" ]; then
          echo "âš ï¸  Could not automatically detect EC2 instance IP"
          echo "Please set EC2_INSTANCE_IP as a repository secret"
          echo "instance_ip=" >> $GITHUB_OUTPUT
        else
          echo "âœ… Found EC2 instance IP: $INSTANCE_IP"
          echo "instance_ip=$INSTANCE_IP" >> $GITHUB_OUTPUT
        fi

    - name: Deploy to EC2 (if IP available)
      if: steps.get-ip.outputs.instance_ip != ''
      run: |
        echo "ðŸš€ Deploying latest images to EC2: ${{ steps.get-ip.outputs.instance_ip }}"
        
        # Note: This requires SSH key setup in GitHub Actions
        # For now, we'll trigger the update via AWS Systems Manager or show manual steps
        echo "âš ï¸  SSH deployment not configured in GitHub Actions"
        echo "The new images are built and pushed to ECR:"
        echo "- Backend: 026596707189.dkr.ecr.eu-central-1.amazonaws.com/moni-be:latest"
        echo "- Frontend: 026596707189.dkr.ecr.eu-central-1.amazonaws.com/moni-fe:latest"
        echo ""
        echo "ðŸ”„ To deploy the NEW images, run this command locally:"
        echo "cd terraform-ec2 && ./manage-app.sh ${{ steps.get-ip.outputs.instance_ip }} update"

    - name: Verify ECR Images
      run: |
        echo "ðŸ” Verifying new images in ECR..."
        aws ecr describe-images \
          --repository-name moni-be \
          --image-ids imageTag=latest \
          --query 'imageDetails[0].imagePushedAt' \
          --output text || echo "Backend image not found"
          
        aws ecr describe-images \
          --repository-name moni-fe \
          --image-ids imageTag=latest \
          --query 'imageDetails[0].imagePushedAt' \
          --output text || echo "Frontend image not found"

    - name: Create deployment notification
      run: |
        echo "## ðŸš€ NEW IMAGES READY FOR DEPLOYMENT" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Fresh Docker Images Built" >> $GITHUB_STEP_SUMMARY
        echo "- **Backend:** \`026596707189.dkr.ecr.eu-central-1.amazonaws.com/moni-be:latest\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Frontend:** \`026596707189.dkr.ecr.eu-central-1.amazonaws.com/moni-fe:latest\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -n "${{ steps.get-ip.outputs.instance_ip }}" ]; then
          echo "### ðŸŽ¯ EC2 Instance Found" >> $GITHUB_STEP_SUMMARY
          echo "**IP Address:** \`${{ steps.get-ip.outputs.instance_ip }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ï¿½ DEPLOY NEW IMAGES NOW" >> $GITHUB_STEP_SUMMARY
          echo "**Run this command to update with the fresh images:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "cd terraform-ec2" >> $GITHUB_STEP_SUMMARY
          echo "./manage-app.sh ${{ steps.get-ip.outputs.instance_ip }} update" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**This will:**" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” Re-authenticate with ECR" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¥ Pull latest images (just built)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”„ Restart containers with new code" >> $GITHUB_STEP_SUMMARY
        else
          echo "### âš ï¸  Manual Deployment Required" >> $GITHUB_STEP_SUMMARY
          echo "Could not automatically detect EC2 instance." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**To deploy the NEW images manually:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "cd terraform-ec2" >> $GITHUB_STEP_SUMMARY
          echo "./manage-app.sh <YOUR_EC2_IP> update" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        fi