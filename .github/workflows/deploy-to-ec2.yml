name: Deploy to EC2 K3s Cluster

on:
  workflow_run:
    workflows: ["Build and Push Docker Images to ECR"]
    types:
      - completed
    branches: [main]
  # Allow manual trigger
  workflow_dispatch:

env:
  AWS_REGION: eu-central-1
  ECR_REGISTRY: 026596707189.dkr.ecr.eu-central-1.amazonaws.com
  ECR_REPOSITORY_BACKEND: moni/moni-be
  ECR_REPOSITORY_FRONTEND: moni/moni-fe

jobs:
  deploy-to-ec2:
    name: Deploy BE/FE to EC2 K3s (Preserve DB)
    runs-on: ubuntu-latest
    # Only run if the build workflow succeeded (or manual trigger)
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Get EC2 Instance IP
      id: get-ip
      run: |
        INSTANCE_IP=$(aws ec2 describe-instances \
          --filters "Name=tag:Name,Values=moni-dev-k3s" "Name=instance-state-name,Values=running" \
          --query "Reservations[0].Instances[0].PublicIpAddress" \
          --output text 2>/dev/null || echo "")
        
        if [ "$INSTANCE_IP" = "None" ] || [ -z "$INSTANCE_IP" ]; then
          # Fallback to secret if available
          if [ -n "${{ secrets.EC2_INSTANCE_IP }}" ]; then
            INSTANCE_IP="${{ secrets.EC2_INSTANCE_IP }}"
            echo "âœ… Using EC2 IP from secrets: $INSTANCE_IP"
          else
            echo "âŒ Could not find EC2 instance IP"
            exit 1
          fi
        else
          echo "âœ… Found EC2 instance IP: $INSTANCE_IP"
        fi
        echo "instance_ip=$INSTANCE_IP" >> $GITHUB_OUTPUT

    - name: Setup SSH Key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/ec2_key
        chmod 600 ~/.ssh/ec2_key
        
        # Add EC2 host to known hosts (skip host key verification for CI)
        ssh-keyscan -H ${{ steps.get-ip.outputs.instance_ip }} >> ~/.ssh/known_hosts 2>/dev/null || true

    - name: Deploy to K3s on EC2
      env:
        EC2_IP: ${{ steps.get-ip.outputs.instance_ip }}
      run: |
        echo "ðŸš€ Deploying to EC2 K3s cluster at $EC2_IP"
        
        # SSH to EC2 with keep-alive to prevent connection drops during long operations
        ssh -i ~/.ssh/ec2_key \
            -o StrictHostKeyChecking=no \
            -o ServerAliveInterval=30 \
            -o ServerAliveCountMax=10 \
            ec2-user@$EC2_IP << 'DEPLOY_SCRIPT'
        
        ECR_REGISTRY="026596707189.dkr.ecr.eu-central-1.amazonaws.com"
        
        echo "ðŸ“¦ Step 1: Refreshing Docker ECR credentials..."
        aws ecr get-login-password --region eu-central-1 | sudo docker login --username AWS --password-stdin $ECR_REGISTRY
        
        echo "ðŸ” Step 2: Pre-pulling images to avoid timeout..."
        sudo docker pull $ECR_REGISTRY/moni/moni-be:latest || echo "Warning: BE image pull failed"
        sudo docker pull $ECR_REGISTRY/moni/moni-fe:latest || echo "Warning: FE image pull failed"
        
        echo "ðŸ”„ Step 3: Restarting Backend deployment..."
        sudo k3s kubectl rollout restart deployment/moni-be -n moni
        
        echo "ðŸ”„ Step 4: Restarting Frontend deployment..."
        sudo k3s kubectl rollout restart deployment/moni-fe -n moni
        
        echo "â³ Step 5: Waiting for rollouts to complete (this may take 1-2 minutes)..."
        echo "Checking pod status every 15 seconds..."
        
        # Wait for backend with progress updates
        for i in $(seq 1 20); do
          if sudo k3s kubectl rollout status deployment/moni-be -n moni --timeout=15s 2>/dev/null; then
            echo "âœ… Backend rollout complete!"
            break
          fi
          echo "  â³ Backend still rolling out... (attempt $i/20)"
          sudo k3s kubectl get pods -n moni -l app=moni-be --no-headers 2>/dev/null || true
        done
        
        # Wait for frontend
        for i in $(seq 1 10); do
          if sudo k3s kubectl rollout status deployment/moni-fe -n moni --timeout=15s 2>/dev/null; then
            echo "âœ… Frontend rollout complete!"
            break
          fi
          echo "  â³ Frontend still rolling out... (attempt $i/10)"
        done
        
        echo ""
        echo "ðŸ“Š Step 6: Final status..."
        sudo k3s kubectl get pods -n moni
        
        # Check if pods are actually running
        BE_READY=$(sudo k3s kubectl get pods -n moni -l app=moni-be -o jsonpath='{.items[0].status.phase}' 2>/dev/null || echo "Unknown")
        FE_READY=$(sudo k3s kubectl get pods -n moni -l app=moni-fe -o jsonpath='{.items[0].status.phase}' 2>/dev/null || echo "Unknown")
        
        echo ""
        echo "Backend status: $BE_READY"
        echo "Frontend status: $FE_READY"
        
        if [ "$BE_READY" = "Running" ] && [ "$FE_READY" = "Running" ]; then
          echo ""
          echo "ðŸŽ‰ Deployment complete! All pods running."
        else
          echo ""
          echo "âš ï¸  Some pods may not be fully ready yet."
          echo "Showing recent pod events..."
          sudo k3s kubectl describe pods -n moni -l app=moni-be 2>/dev/null | tail -20 || true
        fi
        DEPLOY_SCRIPT

    - name: Verify Deployment
      env:
        EC2_IP: ${{ steps.get-ip.outputs.instance_ip }}
      run: |
        echo "ðŸ” Verifying deployment health..."
        
        # Wait a moment for services to be ready
        sleep 10
        
        # Check backend health via NodePort
        HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://$EC2_IP:30080/actuator/health || echo "000")
        
        if [ "$HEALTH_STATUS" = "200" ]; then
          echo "âœ… Backend is healthy (HTTP 200)"
        else
          echo "âš ï¸  Backend health check returned: $HEALTH_STATUS"
          echo "This might be normal if the app is still starting up"
        fi
        
        # Check frontend
        FE_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://$EC2_IP:30081/ || echo "000")
        
        if [ "$FE_STATUS" = "200" ]; then
          echo "âœ… Frontend is healthy (HTTP 200)"
        else
          echo "âš ï¸  Frontend health check returned: $FE_STATUS"
        fi

    - name: Create Deployment Summary
      env:
        EC2_IP: ${{ steps.get-ip.outputs.instance_ip }}
      run: |
        echo "## ðŸš€ Deployment Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Deployed Services" >> $GITHUB_STEP_SUMMARY
        echo "| Service | Status | Image |" >> $GITHUB_STEP_SUMMARY
        echo "|---------|--------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Backend | ðŸ”„ Updated | \`$ECR_REGISTRY/$ECR_REPOSITORY_BACKEND:latest\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Frontend | ðŸ”„ Updated | \`$ECR_REGISTRY/$ECR_REPOSITORY_FRONTEND:latest\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Database | âœ… Preserved | PostgreSQL 16 (data intact) |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŒ Access URLs" >> $GITHUB_STEP_SUMMARY
        echo "- **Frontend:** http://$EC2_IP:30081" >> $GITHUB_STEP_SUMMARY
        echo "- **Backend API:** http://$EC2_IP:30080" >> $GITHUB_STEP_SUMMARY
        echo "- **Health Check:** http://$EC2_IP:30080/actuator/health" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ Commit" >> $GITHUB_STEP_SUMMARY
        echo "Deployed from: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY

    - name: Cleanup SSH Key
      if: always()
      run: |
        rm -f ~/.ssh/ec2_key
